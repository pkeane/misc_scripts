#!/usr/local/bin/php -q
<?
//include("/usr/local/home/staff/ugl/pkeane/htdocs/refsched/functions.html");
//include("/usr/local/home/staff/ugl/pkeane/htdocs/refsched/config.html");
include("/home/ugl/htdocs/staff-ugl/refsched/functions.html");
include("/home/ugl/htdocs/staff-ugl/refsched/config.html");


//email header to add to message
$header = "Cc: pkeane@mail.utexas.edu\n"
        . "From: ref_desk_scheduler";
$now = time();
$todaydate = date("Y-m-d", $now);
$todayphrase = date("D, M j", $now);

$todaydow = date("w", $now);
if ($todaydow == 0) {$todaydow = 7;}
$todaydow = $todaydow - 1;

for ($x=0;$x<10;){ 
	$today_array[] = $todaydow + (7 * $x);
	$x++;
	}
	
$tomorrow = $now + 86400; 
$tomorrowdate = date("Y-m-d", $tomorrow);
$tomorrowphrase = date("D, M j", $tomorrow);

$tomorrowdow = date("w", $tomorrow);
if ($tomorrowdow == 0) {$tomorrowdow = 7;}
$tomorrowdow = $tomorrowdow - 1;

for ($x=0;$x<10;){ 
	$tomorrow_array[] = $tomorrowdow + (7 * $x);
	$x++;
	}

//note that finding monday is based on tomorrow's dow here

$sincemonday = ($tomorrowdow * 86400);
$mon = ($tomorrow - $sincemonday);
$week_mon_date = date("Y-m-d", $mon);

	
$connection = @mysql_connect("$db_url","$u","$p") 
 	or die("Couldn't connect.");
 	$db = @mysql_select_db($db_name, $connection) or die("Couldn't select database.");

//since there are two crontabs, one on each server, we need to make sure the job only gets done once each day, so we set the date and each day check it 
  
	$sql = "
	SELECT cronjob_date 
	FROM cronjob 
	WHERE cronjob_type = 2
	";
	$result = @mysql_query($sql,$connection) or die("Couldn't execute date query.");
	while ($row = mysql_fetch_array($result)) {
	$cronjob_date = $row['cronjob_date'];
	}
	
	if ($cronjob_date == $todaydate) {exit;}
	else {
	$sql = "
	UPDATE cronjob
	SET cronjob_date = '$todaydate',
	cronjob_msg = '$tomorrowphrase job done (one day ahead)'
	WHERE cronjob_type = 2
	";
	$result = @mysql_query($sql,$connection) or die("no update cronjob");

  $sql = "
	SELECT week_id
	FROM week
	WHERE week_mon_date='$week_mon_date'
	";
	$result = @mysql_query($sql,$connection) or die("Couldn't execute query1.");
	$num = mysql_num_rows($result);
	while ($row = mysql_fetch_array($result)) {
	$week_id = $row['week_id'];
	}
   $shifts_sql = implode("' OR shift_num = '", $tomorrow_array);
   $shifts_sql = "shift_num ='" . $shifts_sql . "'";

	$sql = "
    SELECT DISTINCT staff_initials
	FROM shift
	WHERE week_id=$week_id
	AND ($shifts_sql)
	AND staff_initials != ''
	";
	$result = @mysql_query($sql,$connection) or die("Couldn't execute query2a.");
	while ($row = mysql_fetch_array($result)) {
	$staff_initials = $row['staff_initials'];
	

		$sql = "
    	SELECT staff_initials, shift_num
		FROM shift
		WHERE week_id=$week_id
		AND ($shifts_sql)
		AND staff_initials = '$staff_initials'
		ORDER BY shift_num
		";
		$result2 = @mysql_query($sql,$connection) or die("Couldn't execute query2b.");
		while ($row = mysql_fetch_array($result2)) {
		$staff_initials = $row['staff_initials'];
		$shift_num = $row['shift_num'];
		
			
		//grab time from the $shifts array
		
		$shift_group = $shifts[$shift_num];
		$shift_time = "$shift_group[1]";
		$shift_list .= "$shift_time \n";
		
		 	$sql = "
			SELECT staff_id, staff_firstname, staff_lastname, staff_url
			FROM staff
			WHERE staff_initials='$staff_initials'
			AND staff_notify_code = 2
			";
			$result3 = @mysql_query($sql,$connection) or die("Couldn't execute query3.");
			while ($row = mysql_fetch_array($result3)) {
			$staff_id = $row['staff_id'];
			$staff_firstname = $row['staff_firstname'];
			$staff_lastname = $row['staff_lastname'];
			$staff_url = $row['staff_url'];
			
			$file=fopen("$staff_url","r");
		if ($file) {
     		while (!feof($file)) {
       		$line = fgets($file, 1024);
      		if (eregi("mailto:(.*)\"", $line, $out)) {
       		$email = $out[1];
       		break;
      			}
   			}}
    		fclose($file);
    		
			}    }	
			
			if ($email) {	
    		mail("$email", "You have desk hours tomorrow ($tomorrowphrase)" , "$staff_firstname-\n\nYou have reference desk hours tomorrow, $tomorrowphrase.\n\n{$shift_list}\nThis is an automated message generated by the Reference Desk Scheduler.  If you would prefer not to receive these messages, go to $path/staff_mod_form.html?staff_id=$staff_id to change your settings.\n\n", $header);
			unset($shift_list);
			unset($email);
			}
			else {
			unset($shift_list);
			}
 
			}	}

//now for friday notification (in this script we do sunday and monday)


if ($todaydow == 4) {


//first sunday ----------------------------------------------



$sunday = $now + 172800; 
$sundaydate = date("Y-m-d", $sunday);
$sundayphrase = date("D, M j", $sunday);

$sundaydow = 6;

for ($x=0;$x<10;){ 
	$sunday_array[] = 6 + (7 * $x);
	$x++;
	}

  $sql = "
	SELECT week_id
	FROM week
	WHERE week_mon_date='$week_mon_date'
	";
	$result = @mysql_query($sql,$connection) or die("Couldn't execute query1.");
	$num = mysql_num_rows($result);
	while ($row = mysql_fetch_array($result)) {
	$week_id = $row['week_id'];
	}
   $shifts_sql = implode("' OR shift_num = '", $sunday_array);
   $shifts_sql = "shift_num ='" . $shifts_sql . "'";

	$sql = "
    SELECT DISTINCT staff_initials
	FROM shift
	WHERE week_id=$week_id
	AND ($shifts_sql)
	AND staff_initials != ''
	";
	$result = @mysql_query($sql,$connection) or die("Couldn't execute query2.");
	while ($row = mysql_fetch_array($result)) {
	$staff_initials = $row['staff_initials'];

		$sql = "
    		SELECT staff_initials, shift_num
		FROM shift
		WHERE week_id=$week_id
		AND ($shifts_sql)
		AND staff_initials = '$staff_initials'
		ORDER BY shift_num
		";
		$result2 = @mysql_query($sql,$connection) or die("Couldn't execute query2.");
		while ($row = mysql_fetch_array($result2)) {
		$staff_initials = $row['staff_initials'];
		$shift_num = $row['shift_num'];
		$shift_group = $shifts[$shift_num];
		$shift_time = "$shift_group[1]";
		$shift_list .= "$shift_time \n";
		 	$sql = "
			SELECT staff_id, staff_firstname, staff_lastname, staff_url
			FROM staff
			WHERE staff_initials='$staff_initials'
			AND staff_notify_code = 2
			";
			$result3 = @mysql_query($sql,$connection) or die("Couldn't execute query3.");
			while ($row = mysql_fetch_array($result3)) {
			$staff_id = $row['staff_id'];
			$staff_firstname = $row['staff_firstname'];
			$staff_lastname = $row['staff_lastname'];
			$staff_url = $row['staff_url'];
			
			$file=fopen("$staff_url","r");
     		while (!feof($file)) {
       		$line = fgets($file, 1024);
      		if (eregi("mailto:(.*)\"", $line, $out)) {
       		$email = $out[1];
       		break;
      			}
   			}
    		fclose($file);

			}	}
			    		
			if ($email) {    		
    	mail("$email", "You have desk hours Sunday" , "$staff_firstname-\n\nYou have reference desk hours $sundayphrase.\n\n{$shift_list}\nThis is an automated message generated by the Reference Desk Scheduler.  If you would prefer not to receive these messages, go to $path/staff_mod_form.html?staff_id=$staff_id to change your settings.\n\n", $header);
			unset($shift_list); 
			unset($email);
			}
			else {
			unset($shift_list);
			}
	
			}	

//now monday-----------------------------------------


$monday = $now + 259200; 
$mondaydate = date("Y-m-d", $monday);
$mondayphrase = date("D, M j", $monday);

$mondaydow = 5;

for ($x=0;$x<10;){ 
	$monday_array[] = (7 * $x);
	$x++;
	}

  $sql = "
	SELECT week_id
	FROM week
	WHERE week_mon_date='$mondaydate'
	";
	$result = @mysql_query($sql,$connection) or die("Couldn't execute query1.");
	$num = mysql_num_rows($result);
	while ($row = mysql_fetch_array($result)) {
	$week_id = $row['week_id'];
	}
   $shifts_sql = implode("' OR shift_num = '", $monday_array);
   $shifts_sql = "shift_num ='" . $shifts_sql . "'";

	$sql = "
    SELECT DISTINCT staff_initials
	FROM shift
	WHERE week_id=$week_id
	AND ($shifts_sql)
	AND staff_initials != ''
	";
	$result = @mysql_query($sql,$connection) or die("Couldn't execute query2.");
	while ($row = mysql_fetch_array($result)) {
	$staff_initials = $row['staff_initials'];

		$sql = "
    		SELECT staff_initials, shift_num
		FROM shift
		WHERE week_id=$week_id
		AND ($shifts_sql)
		AND staff_initials = '$staff_initials'
		ORDER BY shift_num
		";
		$result2 = @mysql_query($sql,$connection) or die("Couldn't execute query2.");
		while ($row = mysql_fetch_array($result2)) {
		$staff_initials = $row['staff_initials'];
		$shift_num = $row['shift_num'];
		$shift_group = $shifts[$shift_num];
		$shift_time = "$shift_group[1]";
		$shift_list .= "$shift_time \n";
		 	$sql = "
			SELECT staff_id, staff_firstname, staff_lastname, staff_url
			FROM staff
			WHERE staff_initials='$staff_initials'
			AND staff_notify_code = 2
			";
			$result3 = @mysql_query($sql,$connection) or die("Couldn't execute query3.");
			while ($row = mysql_fetch_array($result3)) {
			$staff_id = $row['staff_id'];
			$staff_firstname = $row['staff_firstname'];
			$staff_lastname = $row['staff_lastname'];
			$staff_url = $row['staff_url'];
			
			$file=fopen("$staff_url","r");
     		while (!feof($file)) {
       		$line = fgets($file, 1024);
      		if (eregi("mailto:(.*)\"", $line, $out)) {
       		$email = $out[1];
       		break;
      			}
   			}
    		fclose($file);

			}	}
			    		
			if ($email) {    		
    	mail("$email", "You have desk hours Monday ($mondayphrase)" , "$staff_firstname-\n\nYou have reference desk hours $mondayphrase.\n\n{$shift_list}\nThis is an automated message generated by the Reference Desk Scheduler.  If you would prefer not to receive these messages, go to $path/staff_mod_form.html?staff_id=$staff_id to change your settings.\n\n", $header);
			unset($shift_list); 
			unset($email);
			}
			else {
			unset($shift_list);
			}
	
			}	




}





?>
